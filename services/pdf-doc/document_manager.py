import json
import csv
import sqlite3
import os
from datetime import datetime, date
from typing import Dict, List, Optional

class DocumentManager:
    def __init__(self, data_dir="document_data"):
        self.data_dir = data_dir
        os.makedirs(data_dir, exist_ok=True)
        
        # ÌååÏùº Í≤ΩÎ°úÎì§
        self.db_file = os.path.join(data_dir, "documents.db")
        self.json_file = os.path.join(data_dir, "documents.json")
        self.csv_file = os.path.join(data_dir, "documents.csv")
        
        # Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ Ï¥àÍ∏∞Ìôî
        self.init_database()
    
    def init_database(self):
        """Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ Ï¥àÍ∏∞Ìôî Î∞è ÌÖåÏù¥Î∏î ÏÉùÏÑ±"""
        try:
            # SQL Ïä§ÌÇ§Îßà ÌååÏùº ÏùΩÍ∏∞
            schema_file = os.path.join(os.path.dirname(__file__), "documents.sql")
            
            if os.path.exists(schema_file):
                with open(schema_file, 'r', encoding='utf-8') as f:
                    schema_sql = f.read()
                
                with sqlite3.connect(self.db_file) as conn:
                    # Ïó¨Îü¨ SQL Î¨∏ÏùÑ Ïã§Ìñâ
                    conn.executescript(schema_sql)
                    conn.commit()
                    
                print(f"‚úÖ Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ Ï¥àÍ∏∞Ìôî ÏôÑÎ£å: {self.db_file}")
            else:
                print(f"‚ö†Ô∏è Ïä§ÌÇ§Îßà ÌååÏùº ÏóÜÏùå: {schema_file}")
                self._create_basic_tables()
                
        except Exception as e:
            print(f"‚ùå Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ Ï¥àÍ∏∞Ìôî Ïò§Î•ò: {e}")
            self._create_basic_tables()
    
    def _create_basic_tables(self):
        """Í∏∞Î≥∏ ÌÖåÏù¥Î∏î ÏÉùÏÑ± (Ìè¥Î∞±)"""
        try:
            with sqlite3.connect(self.db_file) as conn:
                conn.execute('''
                    CREATE TABLE IF NOT EXISTS documents (
                        id INTEGER PRIMARY KEY AUTOINCREMENT,
                        filename VARCHAR(255) NOT NULL,
                        conversion_method VARCHAR(50),
                        success BOOLEAN DEFAULT FALSE,
                        kc_number VARCHAR(100),
                        registration_number VARCHAR(100),
                        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
                    )
                ''')
                conn.commit()
                print("‚úÖ Í∏∞Î≥∏ ÌÖåÏù¥Î∏î ÏÉùÏÑ± ÏôÑÎ£å")
        except Exception as e:
            print(f"‚ùå Í∏∞Î≥∏ ÌÖåÏù¥Î∏î ÏÉùÏÑ± Ïò§Î•ò: {e}")
    
    def save_document_data(self, pdf_path: str, extracted_numbers: Dict, 
                          conversion_method: str, success: bool = True, 
                          processing_time: float = 0.0) -> int:
        """Î¨∏ÏÑú Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû• (DB + JSON + CSV)"""
        
        document_data = {
            'timestamp': datetime.now().isoformat(),
            'pdf_path': pdf_path,
            'filename': os.path.basename(pdf_path),
            'conversion_method': conversion_method,
            'success': success,
            'extracted_numbers': extracted_numbers,
            'file_size': os.path.getsize(pdf_path) if os.path.exists(pdf_path) else 0,
            'processing_time': processing_time
        }
        
        # 1. Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ Ï†ÄÏû•
        document_id = self._save_to_database(document_data)
        
        # 2. JSON Ï†ÄÏû• (Î∞±ÏóÖÏö©)
        self._save_to_json(document_data)
        
        # 3. CSV Ï†ÄÏû• (Excel Ìò∏Ìôò)
        self._save_to_csv(document_data)
        
        # 4. Ïã§Ìå® ÏºÄÏù¥Ïä§ Î≥ÑÎèÑ Ï≤òÎ¶¨
        if not success:
            self._save_failed_case(document_id, "Conversion failed")
        
        # 5. ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
        self._update_daily_stats(success, conversion_method, processing_time)
        
        return document_id
    
    def _save_to_database(self, document_data: Dict) -> int:
        """SQLite Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§Ïóê Ï†ÄÏû•"""
        try:
            with sqlite3.connect(self.db_file) as conn:
                cursor = conn.cursor()
                
                # Î¨∏ÏÑú Îç∞Ïù¥ÌÑ∞ ÏÇΩÏûÖ
                cursor.execute('''
                    INSERT INTO documents (
                        filename, original_path, conversion_method, success,
                        kc_number, registration_number, document_number, 
                        business_number, phone_number, file_size, processing_time_seconds
                    ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
                ''', (
                    document_data['filename'],
                    document_data['pdf_path'],
                    document_data['conversion_method'],
                    document_data['success'],
                    document_data['extracted_numbers'].get('kc_number'),
                    document_data['extracted_numbers'].get('registration_number'),
                    document_data['extracted_numbers'].get('document_number'),
                    document_data['extracted_numbers'].get('business_number'),
                    document_data['extracted_numbers'].get('phone_number'),
                    document_data['file_size'],
                    document_data['processing_time']
                ))
                
                document_id = cursor.lastrowid
                conn.commit()
                
                print(f"üíæ DB Ï†ÄÏû• ÏôÑÎ£å: ID {document_id}")
                return document_id
                
        except Exception as e:
            print(f"‚ùå DB Ï†ÄÏû• Ïò§Î•ò: {e}")
            return -1
    
    def _save_failed_case(self, document_id: int, failure_reason: str):
        """Ïã§Ìå® ÏºÄÏù¥Ïä§ Ï†ÄÏû•"""
        try:
            with sqlite3.connect(self.db_file) as conn:
                conn.execute('''
                    INSERT INTO extraction_failures (
                        document_id, failure_reason, failure_type
                    ) VALUES (?, ?, ?)
                ''', (document_id, failure_reason, 'conversion_failure'))
                conn.commit()
                
        except Exception as e:
            print(f"‚ùå Ïã§Ìå® ÏºÄÏù¥Ïä§ Ï†ÄÏû• Ïò§Î•ò: {e}")
    
    def _update_daily_stats(self, success: bool, method: str, processing_time: float):
        """ÏùºÏùº ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏"""
        try:
            today = date.today()
            
            with sqlite3.connect(self.db_file) as conn:
                # Ïò§Îäò ÌÜµÍ≥Ñ ÌôïÏù∏
                cursor = conn.cursor()
                cursor.execute('SELECT id FROM conversion_stats WHERE date = ?', (today,))
                
                if cursor.fetchone():
                    # Í∏∞Ï°¥ ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
                    conn.execute('''
                        UPDATE conversion_stats SET 
                            total_conversions = total_conversions + 1,
                            successful_conversions = successful_conversions + ?,
                            text_based_conversions = text_based_conversions + ?,
                            ocr_based_conversions = ocr_based_conversions + ?,
                            avg_processing_time = (avg_processing_time + ?) / 2
                        WHERE date = ?
                    ''', (
                        1 if success else 0,
                        1 if method == 'text' else 0,
                        1 if method == 'ocr' else 0,
                        processing_time,
                        today
                    ))
                else:
                    # ÏÉà ÌÜµÍ≥Ñ ÏÉùÏÑ±
                    conn.execute('''
                        INSERT INTO conversion_stats (
                            date, total_conversions, successful_conversions,
                            text_based_conversions, ocr_based_conversions, avg_processing_time
                        ) VALUES (?, 1, ?, ?, ?, ?)
                    ''', (
                        today,
                        1 if success else 0,
                        1 if method == 'text' else 0,
                        1 if method == 'ocr' else 0,
                        processing_time
                    ))
                
                conn.commit()
                
        except Exception as e:
            print(f"‚ùå ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏ Ïò§Î•ò: {e}")
    
    def get_failed_documents(self) -> List[Dict]:
        """Í≤ÄÏàòÍ∞Ä ÌïÑÏöîÌïú Ïã§Ìå® Î¨∏ÏÑú Î™©Î°ù Ï°∞Ìöå"""
        try:
            with sqlite3.connect(self.db_file) as conn:
                conn.row_factory = sqlite3.Row
                cursor = conn.cursor()
                
                cursor.execute('''
                    SELECT d.*, ef.failure_reason, ef.manual_review_status
                    FROM documents d
                    JOIN extraction_failures ef ON d.id = ef.document_id
                    WHERE ef.manual_review_status = 'pending'
                    ORDER BY d.created_at DESC
                ''')
                
                return [dict(row) for row in cursor.fetchall()]
                
        except Exception as e:
            print(f"‚ùå Ïã§Ìå® Î¨∏ÏÑú Ï°∞Ìöå Ïò§Î•ò: {e}")
            return []
    
    def get_daily_stats(self, days: int = 7) -> List[Dict]:
        """ÏµúÍ∑º NÏùº ÌÜµÍ≥Ñ Ï°∞Ìöå"""
        try:
            with sqlite3.connect(self.db_file) as conn:
                conn.row_factory = sqlite3.Row
                cursor = conn.cursor()
                
                cursor.execute('''
                    SELECT * FROM conversion_stats 
                    WHERE date >= date('now', '-{} days')
                    ORDER BY date DESC
                '''.format(days))
                
                return [dict(row) for row in cursor.fetchall()]
                
        except Exception as e:
            print(f"‚ùå ÌÜµÍ≥Ñ Ï°∞Ìöå Ïò§Î•ò: {e}")
            return []
    
    def _save_to_json(self, document_data: Dict):
        """JSON Î∞±ÏóÖ Ï†ÄÏû•"""
        try:
            if os.path.exists(self.json_file):
                with open(self.json_file, 'r', encoding='utf-8') as f:
                    data = json.load(f)
            else:
                data = []
            
            data.append(document_data)
            
            with open(self.json_file, 'w', encoding='utf-8') as f:
                json.dump(data, f, ensure_ascii=False, indent=2)
                
        except Exception as e:
            print(f"‚ùå JSON Ï†ÄÏû• Ïò§Î•ò: {e}")
    
    def _save_to_csv(self, document_data: Dict):
        """CSV Ï†ÄÏû• (Excel Ìò∏Ìôò)"""
        try:
            file_exists = os.path.exists(self.csv_file)
            
            with open(self.csv_file, 'a', newline='', encoding='utf-8-sig') as f:
                fieldnames = ['timestamp', 'filename', 'conversion_method', 'success', 
                             'kc_number', 'registration_number', 'document_number', 
                             'business_number', 'processing_time']
                writer = csv.DictWriter(f, fieldnames=fieldnames)
                
                if not file_exists:
                    writer.writeheader()
                
                csv_row = {
                    'timestamp': document_data['timestamp'],
                    'filename': document_data['filename'],
                    'conversion_method': document_data['conversion_method'],
                    'success': document_data['success'],
                    'processing_time': document_data['processing_time']
                }
                
                # Î≤àÌò∏ ÌïÑÎìúÎì§ Ï∂îÍ∞Ä
                for key in ['kc_number', 'registration_number', 'document_number', 'business_number']:
                    csv_row[key] = document_data['extracted_numbers'].get(key, '')
                
                writer.writerow(csv_row)
                
        except Exception as e:
            print(f"‚ùå CSV Ï†ÄÏû• Ïò§Î•ò: {e}")